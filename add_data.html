<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>JustCom Inventory CSV Editor</title>
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding: 20px;
            max-width: 95vw;
            margin: auto;
            color: #222;
            background: #fafafa;
        }

        h2 {
            margin-bottom: 10px;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        button,
        input[type="file"] {
            padding: 8px 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }

        button:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 1200px;
            font-size: 14px;
        }

        th,
        td {
            border: 1px solid #eee;
            padding: 8px;
            vertical-align: middle;
        }

        th {
            background: #f5f7fa;
            position: sticky;
            top: 0;
            z-index: 2;
            min-width: 14rem;
        }

        th:nth-child(10) {
            min-width: 24rem;
        }

        th:last-child {
            min-width: 4rem;
        }

        td:last-child {
            vertical-align: middle;
            text-align: center;
        }

        .ql-container.ql-snow {
            height: auto;
        }

        input,
        select,
        textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }

        textarea {
            height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            body {
                font-size: 13px;
            }

            th,
            td {
                padding: 5px;
            }

            textarea {
                height: 60px;
            }
        }
    </style>
</head>

<body>

    <h2>üì¶ JustCom Inventory Editor</h2>

    <div class="toolbar">
        <button onclick="addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <button onclick="saveCSV()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å CSV</button>
        <!-- <button onclick="loadCSV()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</button> -->
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr id="headerRow"></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
        function encodeBase64(str) {
            return btoa(unescape(encodeURIComponent(str || "")));
        }

        function decodeBase64(str) {
            return decodeURIComponent(escape(atob(str || "")));
        }


        const CSV_PATH = "data/justcom_inventory.csv";

        const columns = [
            "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå", "‡∏£‡∏∏‡πà‡∏ô‡∏¢‡πà‡∏≠‡∏¢", "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", "‡∏£‡∏≤‡∏Ñ‡∏≤ (THB)", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
            "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (active|hidden|sold)", "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å", "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°",
            "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°", "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (‡∏ß‡∏±‡∏ô)", "‡πÅ‡∏ó‡πá‡∏Å",
            "‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà (facebook|line|custom_url)",
            "‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå Facebook (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)", "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å custom_url ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)",
            "‡∏ä‡∏¥‡∏õ/‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏ä‡πà‡∏ô RTX 3060 Ti / RX 6700 XT)", "‡∏™‡πÄ‡∏õ‡∏Å‡∏¢‡πà‡∏≠‡∏¢ (VRAM/‡∏Ç‡∏ô‡∏≤‡∏î/‡∏™‡∏µ ‡∏Ø‡∏•‡∏Ø)", "‡∏™‡∏†‡∏≤‡∏û"
        ];

        const headerRow = document.getElementById("headerRow");
        columns.forEach(col => {
            const th = document.createElement("th");
            th.textContent = col;
            headerRow.appendChild(th);
        });

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        const thDelete = document.createElement("th");
        thDelete.textContent = "‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
        headerRow.appendChild(thDelete);


        const quillEditors = new Map(); // ‡πÄ‡∏Å‡πá‡∏ö quill instance ‡∏ï‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß

        function decodeBase64UTF8(str) {
            try {
                // ‡πÅ‡∏õ‡∏•‡∏á base64 ‚Üí UTF-8
                return decodeURIComponent(escape(atob(str)));
            } catch (e) {
                // fallback ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà base64
                return str;
            }
        }


        function addRow(data = {}) {
            const tr = document.createElement("tr");

            columns.forEach(col => {
                const td = document.createElement("td");
                let el;

                if (col === "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°") {
                    el = document.createElement("div");
                    el.style.height = "120px";
                    td.appendChild(el);

                    const quill = new Quill(el, {
                        theme: "snow",
                        modules: {
                            toolbar: [
                                [{ header: [1, 2, false] }],
                                ["bold", "italic", "underline"],
                                ["link", "image"],
                                [{ list: "ordered" }, { list: "bullet" }],
                                ["clean"]
                            ]
                        }
                    });

                    if (data[col]) {
                        try {
                            const html = decodeBase64UTF8(data[col]);
                            quill.root.innerHTML = html;
                        } catch (e) {
                            quill.root.innerHTML = data[col];
                        }
                    }

                    quillEditors.set(tr, quill);
                } else if (col === "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (active|hidden|sold)") {
                    el = document.createElement("select");
                    ["active", "hidden", "sold"].forEach(v => {
                        const opt = document.createElement("option");
                        opt.value = v; opt.textContent = v;
                        if (v === data[col]) opt.selected = true;
                        el.appendChild(opt);
                    });
                } else if (col === "‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà (facebook|line|custom_url)") {
                    el = document.createElement("select");
                    ["facebook", "line", "custom_url"].forEach(v => {
                        const opt = document.createElement("option");
                        opt.value = v; opt.textContent = v;
                        if (v === data[col]) opt.selected = true;
                        el.appendChild(opt);
                    });
                } else {
                    el = document.createElement("input");
                    el.type = "text";
                    el.value = data[col] || "";
                }

                if (col !== "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°") td.appendChild(el);
                tr.appendChild(td);
            });

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß
            const tdDelete = document.createElement("td");
            const btnDelete = document.createElement("button");
            btnDelete.textContent = "‡∏•‡∏ö";
            btnDelete.style.background = "#ff4d4f";
            btnDelete.style.color = "white";
            btnDelete.onclick = () => {
                quillEditors.delete(tr); // ‡∏•‡∏ö quill instance ‡∏î‡πâ‡∏ß‡∏¢
                tr.remove();
            };
            tdDelete.appendChild(btnDelete);
            tr.appendChild(tdDelete);

            document.querySelector("#dataTable tbody").appendChild(tr);
        }


        window.addEventListener('DOMContentLoaded', loadCSV);


        async function loadCSV() {
            try {
                const res = await fetch("data/justcom_inventory.csv");
                if (!res.ok) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV");
                const text = await res.text();

                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        const tbody = document.querySelector("#dataTable tbody");
                        tbody.innerHTML = "";
                        results.data.forEach(item => addRow(item));
                        // alert("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    },
                    error: function (err) {
                        alert("‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
                    }
                });
            } catch (err) {
                alert("‚ùå ‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
            }
        }


        function parseCSV(line) {
            const regex = /("([^"]*(?:""[^"]*)*)"|[^,]*)/g;
            const result = [];
            let match;
            while ((match = regex.exec(line)) !== null) {
                let val = match[2] ? match[2].replace(/""/g, '"') : match[1];
                result.push(val);
            }
            return result;
        }

        function saveCSV() {
            const rows = [columns.join(",")];

            document.querySelectorAll("#dataTable tbody tr").forEach(tr => {
                const row = [];
                tr.querySelectorAll("td").forEach((td, idx) => {
                    const col = columns[idx];
                    let val = "";

                    if (col === "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°") {
                        const quill = quillEditors.get(tr);
                        if (quill) {
                            const html = quill.root.innerHTML;
                            val = btoa(unescape(encodeURIComponent(html)));
                        }
                    } else {
                        const el = td.querySelector("input,select");
                        val = el ? el.value : "";
                    }

                    val = '"' + val.replace(/"/g, '""') + '"';
                    row.push(val);
                });
                rows.push(row.join(","));
            });

            const blob = new Blob(["\uFEFF" + rows.join("\n")], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = "justcom_inventory.csv";
            link.target = "_blank"; // ‡πÄ‡∏û‡∏¥‡πà‡∏° target ‡πÉ‡∏´‡πâ browser ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Save As
            link.rel = "noopener noreferrer"; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô warning

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ click ‡πÄ‡∏õ‡πá‡∏ô user-initiated
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // ‡∏•‡πâ‡∏≤‡∏á object URL ‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
    </script>
</body>

</html>